<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>QR Code Generator</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: white;
            font-family: Arial, sans-serif;
        }
        #status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        #testQR { margin-top: 20px; }
        #qrtemp { display: none; }
    </style>
</head>
<body>
    <h2>Generador de Códigos QR</h2>
    <div id="status">Inicializando...</div>
    <div id="testQR"></div>

    <!-- Contenedor temporal para generar QR -->
    <div id="qrtemp"></div>

    <!-- Cargar biblioteca QR externa (davidshimjs/qrcodejs) -->
    <script src="qrcode.js"></script>

    <script>
    var statusDiv = document.getElementById('status');

    // Verificar que la biblioteca se cargó correctamente
    function checkLibrary() {
        try {
            // La biblioteca davidshimjs/qrcodejs expone 'QRCode' en el objeto window
            if (typeof QRCode === 'undefined') {
                statusDiv.className = 'error';
                statusDiv.innerHTML = '<strong>ERROR:</strong> No se pudo cargar qrcode.js<br>' +
                                     'Verifique que el archivo existe en la carpeta de la aplicación.';
                console.error('QRCode library not found');
                return false;
            }

            statusDiv.className = 'success';
            statusDiv.innerHTML = '<strong>✓ Biblioteca QR cargada correctamente</strong><br>' +
                                 'Biblioteca: qrcodejs (davidshimjs)<br>' +
                                 'Sistema listo para generar códigos QR';
            console.log('QR library loaded successfully');
            return true;

        } catch(e) {
            statusDiv.className = 'error';
            statusDiv.innerHTML = '<strong>ERROR:</strong> ' + e.message;
            console.error('Error checking library:', e);
            return false;
        }
    }

    // Generar código QR y retornar como imagen base64
    function GenerateQRCode(text, size) {
        try {
            if (typeof QRCode === 'undefined') {
                return 'ERROR: Biblioteca QR no cargada';
            }

            if (!text || text.length === 0) {
                return 'ERROR: Texto vacío';
            }

            // Asegurar tamaño mínimo
            size = size || 200;
            if (size < 50) size = 50;

            // Limpiar contenedor temporal
            var container = document.getElementById('qrtemp');
            container.innerHTML = '';

            // Generar QR usando la biblioteca
            var qr = new QRCode(container, {
                text: text,
                width: size,
                height: size,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.L  // L = 7% corrección
            });

            // La biblioteca genera automáticamente un canvas o img
            // Esperar un momento para que se genere
            setTimeout(function() {}, 100);

            // Buscar el canvas o img generado
            var canvas = container.querySelector('canvas');
            var img = container.querySelector('img');

            if (canvas) {
                // Si hay canvas, convertir directamente a base64
                try {
                    return canvas.toDataURL('image/png');
                } catch(e) {
                    console.error('Error converting canvas to base64:', e);
                    return 'ERROR: No se pudo convertir canvas a base64';
                }
            } else if (img) {
                // Si solo hay img, crear un canvas y copiar la imagen
                var tempCanvas = document.createElement('canvas');
                tempCanvas.width = size;
                tempCanvas.height = size;
                var ctx = tempCanvas.getContext('2d');

                // Esperar a que la imagen cargue
                if (img.complete) {
                    ctx.drawImage(img, 0, 0, size, size);
                    return tempCanvas.toDataURL('image/png');
                } else {
                    return 'ERROR: Imagen no cargada';
                }
            } else {
                return 'ERROR: No se generó canvas ni imagen';
            }

        } catch(e) {
            console.error('Error generating QR:', e);
            return 'ERROR: ' + e.message;
        }
    }

    // Función de prueba
    function testQR() {
        try {
            var testEAN = '2410788252771';

            // Generar QR visible en la página
            var testContainer = document.getElementById('testQR');
            testContainer.innerHTML = '<strong>QR de prueba:</strong><br><div id="testqrcode"></div>';

            var testQRDiv = document.getElementById('testqrcode');
            var qr = new QRCode(testQRDiv, {
                text: testEAN,
                width: 150,
                height: 150,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.L
            });

            testContainer.innerHTML += '<br><small>EAN13: ' + testEAN + '</small>';

            // Probar también la función para VB6
            setTimeout(function() {
                var result = GenerateQRCode(testEAN, 200);
                if (result && result.indexOf('ERROR') === -1 && result.indexOf('data:image') === 0) {
                    console.log('Test QR for VB6 generated successfully, base64 length:', result.length);
                } else {
                    console.error('Test for VB6 failed:', result);
                }
            }, 200);

        } catch(e) {
            statusDiv.className = 'error';
            statusDiv.innerHTML = '<strong>ERROR en prueba:</strong> ' + e.message;
            console.error('Test error:', e);
        }
    }

    // Exponer funciones para VB6
    window.GenerateQRCode = GenerateQRCode;
    window.qrReady = false;

    // Inicializar cuando cargue la página
    window.onload = function() {
        console.log('Page loaded, checking library...');

        // Verificar biblioteca
        if (checkLibrary()) {
            window.qrReady = true;

            // Generar QR de prueba
            testQR();

            console.log('QR Generator ready for use from VB6');
        } else {
            window.qrReady = false;
            console.error('QR Generator failed to initialize');
        }
    };

    // Manejo de errores del script externo
    window.addEventListener('error', function(e) {
        if (e.filename && e.filename.indexOf('qrcode.js') !== -1) {
            statusDiv.className = 'error';
            statusDiv.innerHTML = '<strong>ERROR:</strong> No se pudo cargar qrcode.js<br>' +
                                 'Archivo: ' + e.filename + '<br>' +
                                 'Asegúrese de que el archivo está en la carpeta de la aplicación.';
            window.qrReady = false;
        }
    }, true);
    </script>
</body>
</html>
